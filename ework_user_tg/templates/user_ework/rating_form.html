{% load widget_tweaks %}
{% load i18n %}

<div class="modal-content">
    <div class="modal-header">
        <h5 class="modal-title">
            {% blocktrans with user=to_user.get_full_name %}Оставить отзыв пользователю {{ user }}{% endblocktrans %}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
    </div>
    <div class="modal-body">
        {% if existing_rating %}
            <div class="alert alert-info">
                <h6>{% trans "Вы уже оценивали этого пользователя" %}</h6>
                <p><strong>{% trans "Ваша оценка:" %}</strong> 
                    {% for i in "12345" %}
                        {% if forloop.counter <= existing_rating.rating %}⭐{% else %}☆{% endif %}
                    {% endfor %}
                    ({{ existing_rating.rating }}/5)
                </p>
                {% if existing_rating.comment %}
                    <p><strong>{% trans "Комментарий:" %}</strong> {{ existing_rating.comment }}</p>
                {% endif %}
                <small class="text-muted">{% trans "Дата:" %} {{ existing_rating.created_at|date:"d.m.Y H:i" }}</small>
            </div>
        {% elif not can_rate %}
            <div class="alert alert-warning">
                {% trans "Вы не можете оценить этого пользователя" %}
            </div>
        {% else %}
            <form hx-post="{% url 'user:create_rating' user_id=to_user.id %}" hx-target="#rating-result" hx-swap="innerHTML">
                {% csrf_token %}
                
                <div class="mb-3">
                    <label class="form-label">{{ form.rating.label }}</label>
                    <div class="rating-stars d-flex align-items-center">
                        {% for choice in form.rating.field.choices %}
                            <div class="form-check me-2">
                                <input class="form-check-input d-none" type="radio" name="rating" id="rating{{ choice.0 }}" value="{{ choice.0 }}">
                                <label class="form-check-label star-label" for="rating{{ choice.0 }}" style="cursor: pointer; font-size: 1.5em;">
                                    <i class="material-icons text-muted star-icon">star_border</i>
                                </label>
                            </div>
                        {% endfor %}
                    </div>
                    <small class="form-text text-muted">{{ form.rating.help_text }}</small>
                </div>
                
                <div class="mb-3">
                    <label for="{{ form.comment.id_for_label }}" class="form-label">{{ form.comment.label }}</label>
                    {% render_field form.comment class="form-control" %}
                </div>
                
                <div id="rating-result"></div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Отмена" %}</button>
                    <button type="submit" class="btn btn-primary">{% trans "Отправить отзыв" %}</button>
                </div>
            </form>
        {% endif %}
    </div>
</div>

<script>
// Интерактивные звезды
document.addEventListener('DOMContentLoaded', function() {
    const starLabels = document.querySelectorAll('.star-label');
    const starIcons = document.querySelectorAll('.star-icon');
    
    starLabels.forEach((label, index) => {
        // Подсветка при наведении
        label.addEventListener('mouseenter', function() {
            for (let i = 0; i <= index; i++) {
                starIcons[i].textContent = 'star';
                starIcons[i].classList.remove('text-muted');
                starIcons[i].classList.add('text-warning');
            }
            for (let i = index + 1; i < starIcons.length; i++) {
                starIcons[i].textContent = 'star_border';
                starIcons[i].classList.remove('text-warning');
                starIcons[i].classList.add('text-muted');
            }
        });
        
        // Клик по звезде
        label.addEventListener('click', function() {
            const radio = document.getElementById('rating' + (index + 1));
            radio.checked = true;
            updateStars(index);
        });
    });
    
    // Восстановление состояния при уходе мыши
    document.querySelector('.rating-stars').addEventListener('mouseleave', function() {
        const checkedRadio = document.querySelector('input[name="rating"]:checked');
        if (checkedRadio) {
            updateStars(parseInt(checkedRadio.value) - 1);
        } else {
            resetStars();
        }
    });
    
    function updateStars(selectedIndex) {
        for (let i = 0; i <= selectedIndex; i++) {
            starIcons[i].textContent = 'star';
            starIcons[i].classList.remove('text-muted');
            starIcons[i].classList.add('text-warning');
        }
        for (let i = selectedIndex + 1; i < starIcons.length; i++) {
            starIcons[i].textContent = 'star_border';
            starIcons[i].classList.remove('text-warning');
            starIcons[i].classList.add('text-muted');
        }
    }
    
    function resetStars() {
        starIcons.forEach(icon => {
            icon.textContent = 'star_border';
            icon.classList.remove('text-warning');
            icon.classList.add('text-muted');
        });
    }
});

// Обработка успешной отправки отзыва
document.addEventListener('htmx:afterRequest', function(event) {
    if (event.detail.elt.closest('form')) {
        const response = JSON.parse(event.detail.xhr.responseText);
        const resultDiv = document.getElementById('rating-result');
        
        if (response.success) {
            resultDiv.innerHTML = '<div class="alert alert-success">' + response.message + '</div>';
            // Закрываем модальное окно через 2 секунды
            setTimeout(() => {
                const modal = bootstrap.Modal.getInstance(document.querySelector('.modal'));
                if (modal) modal.hide();
            }, 2000);
        } else {
            resultDiv.innerHTML = '<div class="alert alert-danger">' + 
                (response.error || 'Произошла ошибка') + '</div>';
        }
    }
});
</script>
