{% load widget_tweaks %}
{% load i18n %}

{% with WIDGET_ERROR_CLASS="is-invalid" %}
<form hx-post="{{ request.path }}" hx-target="this" hx-swap="outerHTML" class="modal-content" id="post-form">
    {% csrf_token %}

    <div class="modal-header">
        <h5 class="modal-title">
            {% if object %}
                {% trans "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —É—Å–ª—É–≥—É" %}
            {% else %}
                {% trans "–†–∞–∑–º–µ—Å—Ç–∏—Ç—å —É—Å–ª—É–≥—É" %}
            {% endif %}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>

    <div class="modal-body">
        <!-- –í—Å–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã –∫–∞–∫ —É –≤–∞—Å –±—ã–ª–æ -->
        <div class="mb-3">
            <label for="{{ form.title.id_for_label }}" class="form-label">{% trans "–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏" %}</label>
            {% render_field form.title class="form-control" error_class=WIDGET_ERROR_CLASS %}
        </div>

        <div class="mb-3">
            <label for="{{ form.description.id_for_label }}" class="form-label">{% trans "–û–ø–∏—Å–∞–Ω–∏–µ —É—Å–ª—É–≥–∏" %}</label>
            {% render_field form.description class="form-control" error_class=WIDGET_ERROR_CLASS rows="5" %}
        </div>

        <div class="row mb-3">
            <div class="col-8">
                <label for="{{ form.price.id_for_label }}" class="form-label">{% trans "–û–ø–ª–∞—Ç–∞" %}</label>
                {% render_field form.price class="form-control" error_class=WIDGET_ERROR_CLASS %}
            </div>
            <div class="col-4">
                <label for="{{ form.currency.id_for_label }}" class="form-label">{% trans "–í–∞–ª—é—Ç–∞" %}</label>
                {% render_field form.currency class="form-control" error_class=WIDGET_ERROR_CLASS %}
            </div>
        </div>

        <div class="mb-3">
            <label for="{{ form.city.id_for_label }}" class="form-label">{% trans "–ì–æ—Ä–æ–¥" %}</label>
            {% render_field form.city class="form-control" error_class=WIDGET_ERROR_CLASS %}
        </div>
        
        <div class="mb-3">
            <label for="{{ form.sub_rubric.id_for_label }}" class="form-label">{% trans "–ö–∞—Ç–µ–≥–æ—Ä–∏—è" %}</label>
            {% render_field form.sub_rubric class="form-control" error_class=WIDGET_ERROR_CLASS %}
        </div>

        <div class="mb-3">
            <label for="{{ form.user_phone.id_for_label }}" class="form-label">{% trans "–¢–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —Å–≤—è–∑–∏" %}</label>
            {% render_field form.user_phone class="form-control" error_class=WIDGET_ERROR_CLASS %}
        </div>

        <div class="d-grid gap-3 d-md-flex justify-content-md-end">
        <button type='button' class='btn btn-secondary' data-bs-dismiss='modal'>{% trans "–û—Ç–º–µ–Ω–∞" %}</button>
        {% if object %}
            <button type="submit" class="btn btn-primary">{% trans "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è" %}</button>
        {% else %}
            <button type="button" class="btn btn-primary" onclick="initPayment()">
                üí≥ {% trans "–û–ø–ª–∞—Ç–∏—Ç—å –∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å" %} (10‚ÇΩ)
            </button>
        {% endif %}
    </div>
</form>

<script>
async function initPayment() {
    const form = document.getElementById('post-form');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ñ–æ—Ä–º—ã –ø–µ—Ä–µ–¥ –æ–ø–ª–∞—Ç–æ–π
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
        const response = await fetch('/payments/create_payment/', { 
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞');
        }
        
        const data = await response.json();
        
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–ª–∞—Ç–µ–∂–Ω–æ–µ –æ–∫–Ω–æ
        window.Telegram.WebApp.openInvoice(data.invoice_link, (status) => {
            if (status === 'paid') {
                console.logg('Payment successful');
                // –£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞ - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
                form.submit();
            } else {
                alert('–û–ø–ª–∞—Ç–∞ –Ω–µ –±—ã–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –û–±—ä—è–≤–ª–µ–Ω–∏–µ –Ω–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ.');
            }
        });
    } catch (error) {
        console.error('Payment error:', error);
        alert('–û—à–∏–±–∫–∞: ' + error.message);
    }
}
</script>
{% endwith %}