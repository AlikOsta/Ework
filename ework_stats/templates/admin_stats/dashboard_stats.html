{% extends "admin/base_site.html" %}
{% load i18n %}
{% load static %}

{% block title %}Статистика Сарубага{% endblock %}

{% block extrahead %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<style>
    .stats-container {
        padding: 20px;
        background: #f8f9fa;
        min-height: 100vh;
    }
    
    .header-section {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .main-stat-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: transform 0.3s, box-shadow 0.3s;
        height: 100%;
    }
    
    .main-stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }
    
    .stat-icon {
        width: 48px;
        height: 48px;
        margin: 0 auto 16px;
        padding: 12px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: white;
    }
    
    .stat-icon.users { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .stat-icon.posts { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .stat-icon.active { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
    .stat-icon.favorites { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
    .stat-icon.revenue { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
    
    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 8px;
        line-height: 1;
    }
    
    .stat-label {
        color: #7f8c8d;
        font-size: 0.9rem;
        font-weight: 500;
    }
    
    .section-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        cursor: pointer;
        transition: all 0.3s;
        height: 100%;
    }
    
    .section-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }
    
    .chart-container {
        position: relative;
        height: 150px;
        margin-bottom: 15px;
    }
    
    .stats-summary {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 12px;
        border-top: 1px solid #e9ecef;
    }
    
    .summary-item {
        text-align: center;
        font-size: 0.8rem;
    }
    
    .summary-value {
        font-size: 1rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 2px;
    }
    
    .summary-label {
        font-size: 0.7rem;
        color: #7f8c8d;
    }
    
    .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 150px;
        color: #7f8c8d;
    }
    
    .loading::after {
        content: '';
        width: 20px;
        height: 20px;
        border: 2px solid #e9ecef;
        border-top: 2px solid #4285f4;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-left: 10px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="stats-container">
    <!-- Заголовок и селектор периода -->
    <div class="header-section">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
            <h1 class="h2 mb-0">Статистика Сарубага</h1>
            <div class="btn-group mt-2 mt-lg-0" role="group">
                <input type="radio" class="btn-check" name="period" id="day" value="day">
                <label class="btn btn-outline-primary" for="day">День</label>
                
                <input type="radio" class="btn-check" name="period" id="week" value="week">
                <label class="btn btn-outline-primary" for="week">Неделя</label>
                
                <input type="radio" class="btn-check" name="period" id="month" value="month" checked>
                <label class="btn btn-outline-primary" for="month">Месяц</label>
                
                <input type="radio" class="btn-check" name="period" id="year" value="year">
                <label class="btn btn-outline-primary" for="year">Год</label>
            </div>
        </div>
    </div>

    <!-- Основные показатели -->
    <div class="row g-3 mb-4">
        <div class="col-lg-2 col-md-4 col-sm-6">
            <div class="main-stat-card">
                <div class="stat-icon users">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-number" id="total-users">-</div>
                <div class="stat-label">Всего пользователей</div>
            </div>
        </div>
        
        <div class="col-lg-2 col-md-4 col-sm-6">
            <div class="main-stat-card">
                <div class="stat-icon posts">
                    <i class="fas fa-newspaper"></i>
                </div>
                <div class="stat-number" id="total-posts">-</div>
                <div class="stat-label">Всего объявлений</div>
            </div>
        </div>
        
        <div class="col-lg-2 col-md-4 col-sm-6">
            <div class="main-stat-card">
                <div class="stat-icon active">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-number" id="active-posts">-</div>
                <div class="stat-label">Активных объявлений</div>
            </div>
        </div>
        
        <div class="col-lg-2 col-md-4 col-sm-6">
            <div class="main-stat-card">
                <div class="stat-icon favorites">
                    <i class="fas fa-heart"></i>
                </div>
                <div class="stat-number" id="total-favorites">-</div>
                <div class="stat-label">Добавлено в избранное</div>
            </div>
        </div>
        
        <div class="col-lg-2 col-md-4 col-sm-6">
            <div class="main-stat-card">
                <div class="stat-icon revenue">
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="stat-number" id="total-revenue">-</div>
                <div class="stat-label">Общий доход (₽)</div>
            </div>
        </div>
    </div>

    <!-- Секции с подробной статистикой -->
    <div class="row g-3">
        <!-- Пользователи -->
        <div class="col-lg-4 col-md-6">
            <div class="section-card" onclick="location.href='/admin/stats/users/'">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Пользователи</h5>
                    <a href="/admin/stats/users/" class="btn btn-sm btn-outline-primary">Подробнее</a>
                </div>
                <div class="chart-container">
                    <canvas id="usersChart"></canvas>
                </div>
                <div class="stats-summary">
                    <div class="summary-item">
                        <div class="summary-value" id="new-users">-</div>
                        <div class="summary-label">Новых пользователей</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="active-users">-</div>
                        <div class="summary-label">Активных пользователей</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="users-growth">-</div>
                        <div class="summary-label">Активных за неделю</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Объявления -->
        <div class="col-lg-4 col-md-6">
            <div class="section-card" onclick="location.href='/admin/stats/posts/'">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Объявления</h5>
                    <a href="/admin/stats/posts/" class="btn btn-sm btn-outline-primary">Подробнее</a>
                </div>
                <div class="chart-container">
                    <canvas id="postsChart"></canvas>
                </div>
                <div class="stats-summary">
                    <div class="summary-item">
                        <div class="summary-value" id="new-posts">-</div>
                        <div class="summary-label">Новых объявлений</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="posts-moderation">-</div>
                        <div class="summary-label">На модерации</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="posts-growth">-</div>
                        <div class="summary-label">Активных объявлений</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Финансы -->
        <div class="col-lg-4 col-md-6">
            <div class="section-card" onclick="location.href='/admin/stats/finance/'">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Финансы</h5>
                    <a href="/admin/stats/finance/" class="btn btn-sm btn-outline-primary">Подробнее</a>
                </div>
                <div class="chart-container">
                    <canvas id="financeChart"></canvas>
                </div>
                <div class="stats-summary">
                    <div class="summary-item">
                        <div class="summary-value" id="period-revenue">-</div>
                        <div class="summary-label">Доход за период</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="total-payments">-</div>
                        <div class="summary-label">Всего платежей</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="avg-payment">-</div>
                        <div class="summary-label">Средний чек</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let usersChart, postsChart, financeChart;
let currentPeriod = 'month';

// Конфигурация графиков
const chartConfig = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
        legend: {
            display: false
        }
    },
    scales: {
        x: {
            display: true,
            grid: {
                display: false
            }
        },
        y: {
            display: true,
            beginAtZero: true,
            grid: {
                color: '#f0f0f0'
            }
        }
    },
    elements: {
        point: {
            radius: 2,
            hoverRadius: 4
        }
    }
};

// Инициализация графиков
function initCharts() {
    // График пользователей
    const usersCtx = document.getElementById('usersChart').getContext('2d');
    usersChart = new Chart(usersCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Новые пользователи',
                data: [],
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderWidth: 2,
                tension: 0.4,
                fill: true
            }]
        },
        options: chartConfig
    });

    // График объявлений
    const postsCtx = document.getElementById('postsChart').getContext('2d');
    postsChart = new Chart(postsCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Новые объявления',
                data: [],
                borderColor: '#f5576c',
                backgroundColor: 'rgba(245, 87, 108, 0.1)',
                borderWidth: 2,
                tension: 0.4,
                fill: true
            }]
        },
        options: chartConfig
    });

    // График финансов
    const financeCtx = document.getElementById('financeChart').getContext('2d');
    financeChart = new Chart(financeCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Доход',
                data: [],
                borderColor: '#43e97b',
                backgroundColor: 'rgba(67, 233, 123, 0.1)',
                borderWidth: 2,
                tension: 0.4,
                fill: true
            }]
        },
        options: chartConfig
    });
}

// Загрузка данных
async function loadData(period = 'month') {
    currentPeriod = period;
    
    console.log('Загружаем данные для периода:', period);
    
    try {
        // Загружаем данные параллельно
        const [usersData, postsData, viewsData, revenueData] = await Promise.all([
            fetch(`/admin/stats/api/users/?period=${period}`).then(r => {
                console.log('Users API response status:', r.status);
                if (!r.ok) throw new Error('Users API failed');
                return r.json();
            }),
            fetch(`/admin/stats/api/posts/?period=${period}`).then(r => {
                console.log('Posts API response status:', r.status);
                if (!r.ok) throw new Error('Posts API failed');
                return r.json();
            }),
            fetch(`/admin/stats/api/views/?period=${period}`).then(r => {
                console.log('Views API response status:', r.status);
                if (!r.ok) throw new Error('Views API failed');
                return r.json();
            }),
            fetch(`/admin/stats/api/revenue/?period=${period}`).then(r => {
                console.log('Revenue API response status:', r.status);
                if (!r.ok) throw new Error('Revenue API failed');
                return r.json();
            })
        ]);
        
        console.log('Данные успешно загружены:', {
            users: usersData.total_users,
            posts: postsData.total_posts,
            views: viewsData.total_views
        });
        
        // Обновляем основные показатели
        document.getElementById('total-users').textContent = usersData.total_users.toLocaleString();
        document.getElementById('total-posts').textContent = postsData.total_posts.toLocaleString();
        document.getElementById('active-posts').textContent = postsData.active_posts.toLocaleString();
        document.getElementById('total-favorites').textContent = viewsData.total_favorites.toLocaleString();
        document.getElementById('total-revenue').textContent = revenueData.total_revenue.toLocaleString();
        
        // Обновляем дополнительные показатели
        document.getElementById('new-users').textContent = usersData.active_users.toLocaleString();
        document.getElementById('active-users').textContent = usersData.daily_active_users.toLocaleString();
        document.getElementById('users-growth').textContent = usersData.weekly_active_users.toLocaleString();
        
        document.getElementById('new-posts').textContent = postsData.datasets[0].data.reduce((a, b) => a + b, 0);
        document.getElementById('posts-moderation').textContent = postsData.status_data[0] || 0;
        document.getElementById('posts-growth').textContent = postsData.active_posts.toLocaleString();
        
        document.getElementById('period-revenue').textContent = revenueData.datasets[0].data.reduce((a, b) => a + b, 0).toLocaleString();
        document.getElementById('total-payments').textContent = revenueData.total_payments.toLocaleString();
        document.getElementById('avg-payment').textContent = revenueData.avg_payment.toLocaleString();
        
        // Обновляем графики
        updateChart(usersChart, usersData.labels, usersData.datasets[0].data);
        updateChart(postsChart, postsData.labels, postsData.datasets[0].data);
        updateChart(financeChart, revenueData.labels, revenueData.datasets[0].data);
        
    } catch (error) {
        console.error('Ошибка загрузки данных:', error);
        
        // Устанавливаем значения по умолчанию при ошибке
        document.getElementById('total-users').textContent = '0';
        document.getElementById('total-posts').textContent = '0';
        document.getElementById('active-posts').textContent = '0';
        document.getElementById('total-favorites').textContent = '0';
        document.getElementById('total-revenue').textContent = '0';
        
        // Показываем уведомление об ошибке
        alert('Ошибка загрузки данных статистики. Проверьте консоль для деталей.');
    }
}

// Обновление графика
function updateChart(chart, labels, data) {
    chart.data.labels = labels;
    chart.data.datasets[0].data = data;
    chart.update('none');
}

// Обработчики событий
document.addEventListener('DOMContentLoaded', function() {
    initCharts();
    loadData();

    // Обработчик кнопок периода
    document.querySelectorAll('input[name="period"]').forEach(btn => {
        btn.addEventListener('change', function() {
            if (this.checked) {
                loadData(this.value);
            }
        });
    });
});
</script>
{% endblock %}