{% extends "admin/base_site.html" %}
{% load i18n %}
{% load static %}

{% block title %}Статистика объявлений - Сарубага{% endblock %}

{% block extrahead %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<style>
    .stats-container {
        padding: 20px;
        background: #f8f9fa;
        min-height: 100vh;
    }
    
    .header-section {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .status-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        height: 100%;
    }
    
    .status-badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 12px;
    }
    
    .status-moderation { background: #fff3cd; color: #856404; }
    .status-approved { background: #d1ecf1; color: #0c5460; }
    .status-rejected { background: #f8d7da; color: #721c24; }
    .status-published { background: #d4edda; color: #155724; }
    .status-archived { background: #e2e3e5; color: #495057; }
    
    .status-count {
        font-size: 1.8rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 4px;
    }
    
    .status-label {
        font-size: 0.9rem;
        color: #7f8c8d;
    }
    
    .top-posts-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .post-title {
        font-weight: 600;
        color: #2c3e50;
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
</style>
{% endblock %}

{% block content %}
<div class="stats-container">
    <!-- Заголовок -->
    <div class="header-section">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
            <div class="d-flex align-items-center">
                <i class="fas fa-newspaper me-2"></i>
                <h1 class="h2 mb-0">Статистика объявлений</h1>
            </div>
            <div class="d-flex gap-2 align-items-center flex-wrap">
                <a href="/admin/stats/dashboard/" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i>
                    Назад к общей статистике
                </a>
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="period" id="day" value="day">
                    <label class="btn btn-outline-primary" for="day">День</label>
                    
                    <input type="radio" class="btn-check" name="period" id="week" value="week">
                    <label class="btn btn-outline-primary" for="week">Неделя</label>
                    
                    <input type="radio" class="btn-check" name="period" id="month" value="month" checked>
                    <label class="btn btn-outline-primary" for="month">Месяц</label>
                    
                    <input type="radio" class="btn-check" name="period" id="year" value="year">
                    <label class="btn btn-outline-primary" for="year">Год</label>
                </div>
            </div>
        </div>
    </div>

    <!-- Статусы объявлений -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Распределение по статусам</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-lg-2 col-md-4 col-sm-6">
                    <div class="status-card">
                        <div class="status-badge status-moderation">На модерации</div>
                        <div class="status-count" id="status-moderation">-</div>
                        <div class="status-label">объявлений</div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 col-sm-6">
                    <div class="status-card">
                        <div class="status-badge status-approved">Одобрено</div>
                        <div class="status-count" id="status-approved">-</div>
                        <div class="status-label">объявлений</div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 col-sm-6">
                    <div class="status-card">
                        <div class="status-badge status-rejected">Отклонено</div>
                        <div class="status-count" id="status-rejected">-</div>
                        <div class="status-label">объявлений</div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 col-sm-6">
                    <div class="status-card">
                        <div class="status-badge status-published">Опубликовано</div>
                        <div class="status-count" id="status-published">-</div>
                        <div class="status-label">объявлений</div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 col-sm-6">
                    <div class="status-card">
                        <div class="status-badge status-archived">В архиве</div>
                        <div class="status-count" id="status-archived">-</div>
                        <div class="status-label">объявлений</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Топ объявлений -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Топ объявлений по избранному</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Объявление</th>
                            <th>Автор</th>
                            <th>Категория</th>
                            <th>Избранное</th>
                            <th>Дата создания</th>
                            <th>Статус</th>
                        </tr>
                    </thead>
                    <tbody id="top-posts-body">
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                <div class="spinner-border spinner-border-sm me-2" role="status">
                                    <span class="visually-hidden">Загрузка...</span>
                                </div>
                                Загрузка данных...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
let currentPeriod = 'month';

// Загрузка данных
async function loadData(period = 'month') {
    currentPeriod = period;
    
    try {
        const response = await fetch(`/admin/stats/api/posts/?period=${period}`);
        const data = await response.json();
        
        // Обновляем статусы
        const statusLabels = ['status-moderation', 'status-approved', 'status-rejected', 'status-published', 'status-archived'];
        statusLabels.forEach((label, index) => {
            document.getElementById(label).textContent = (data.status_data[index] || 0).toLocaleString();
        });
        
        // Загружаем топ объявлений
        loadTopPosts();
        
    } catch (error) {
        console.error('Ошибка загрузки данных:', error);
    }
}

// Загрузка топ объявлений
async function loadTopPosts() {
    try {
        const response = await fetch(`/admin/stats/api/views/?period=${currentPeriod}`);
        const data = await response.json();
        
        const tbody = document.getElementById('top-posts-body');
        
        if (data.top_posts && data.top_posts.length > 0) {
            tbody.innerHTML = data.top_posts.map(post => `
                <tr>
                    <td class="post-title">${post.title}</td>
                    <td>@user</td>
                    <td>Разное</td>
                    <td><strong>${post.favorites}</strong></td>
                    <td>Недавно</td>
                    <td><span class="badge bg-success">Опубликовано</span></td>
                </tr>
            `).join('');
        } else {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted py-4">
                        Нет данных для отображения
                    </td>
                </tr>
            `;
        }
        
    } catch (error) {
        console.error('Ошибка загрузки топ объявлений:', error);
        document.getElementById('top-posts-body').innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-danger py-4">
                    Ошибка загрузки данных
                </td>
            </tr>
        `;
    }
}

// Обработчики событий
document.addEventListener('DOMContentLoaded', function() {
    loadData();

    // Обработчик кнопок периода
    document.querySelectorAll('input[name="period"]').forEach(btn => {
        btn.addEventListener('change', function() {
            if (this.checked) {
                loadData(this.value);
            }
        });
    });
});
</script>
{% endblock %}