{% load widget_tweaks %}
{% load i18n %}

{# Подключаем Material Icons и HTMX #}
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<script src="https://unpkg.com/htmx.org@1.9.2"></script>

<style>
  .rating {
    display: inline-flex;
    flex-direction: row-reverse; /* чтобы ~ работал "вперёд" по списку */
    gap: 0.25rem;
  }
  .rating input {
    display: none;
  }
  .rating label {
    cursor: pointer;
    font-size: 2.5rem;
    color: var(--bs-gray-300);
    transition: color 0.1s ease-in-out;
  }
  /* при наведении: все звёзды до курсора */
  .rating label:hover,
  .rating label:hover ~ label {
    color: var(--bs-warning);
  }
  /* при выборе: все звёзды до выбранной остаются окрашенными */
  .rating input:checked ~ label,
  .rating input:checked ~ label ~ label {
    color: var(--bs-warning);
  }
</style>

<div class="modal-content">
  <div class="modal-header bg-primary text-white">
    <h5 class="modal-title">
      {% blocktrans with user=to_user.get_full_name %}Оставить отзыв пользователю {{ user }}{% endblocktrans %}
    </h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Закрыть"></button>
  </div>

  <div class="modal-body">
    {% if existing_rating %}
      <div class="alert alert-info">
        <h6>{% trans "Вы уже оценивали этого пользователя" %}</h6>
        <p>
          {% for i in "12345" %}
            {% if forloop.counter <= existing_rating.rating %}⭐{% else %}☆{% endif %}
          {% endfor %}
          ({{ existing_rating.rating }}/5)
        </p>
        {% if existing_rating.comment %}
          <p><strong>{% trans "Комментарий:" %}</strong> {{ existing_rating.comment }}</p>
        {% endif %}
        <small class="text-muted">{{ existing_rating.created_at|date:"d.m.Y H:i" }}</small>
      </div>
    {% elif not can_rate %}
      <div class="alert alert-warning">
        {% trans "Вы не можете оценить этого пользователя" %}
      </div>
    {% else %}
      <form
        hx-post="{% url 'user:create_rating' user_id=to_user.id %}"
        hx-trigger="change"
        hx-target="#rating-result"
        hx-swap="innerHTML"
      >
        {% csrf_token %}

        <div class="mb-4 text-center">
          <label class="form-label mb-3">{{ form.rating.label }}</label>
          <div class="rating">
            {% for choice in form.rating.field.choices %}
              <input
                type="radio"
                name="rating"
                id="rating{{ choice.0 }}"
                value="{{ choice.0 }}"
                {% if existing_rating and existing_rating.rating == choice.0 %}checked{% endif %}
              >
              <label for="rating{{ choice.0 }}">
                <i class="material-icons">star</i>
              </label>
            {% endfor %}
          </div>
          <div class="form-text mt-2">{{ form.rating.help_text }}</div>
        </div>

        <div id="rating-result"></div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            {% trans "Отмена" %}
          </button>
          <button type="submit" class="btn btn-primary">
            {% trans "Отправить отзыв" %}
          </button>
        </div>
      </form>
    {% endif %}
  </div>
</div>
