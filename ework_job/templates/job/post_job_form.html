{% load widget_tweaks %}
{% load i18n %}
{% load static %}

{% with WIDGET_ERROR_CLASS="is-invalid" %}
<form hx-post="{{ request.path }}" hx-target="this" hx-swap="outerHTML" hx-encoding="multipart/form-data" class="modal-content" enctype="multipart/form-data">
    {% csrf_token %}

    <div class="modal-header">
        <h5 class="modal-title">{% trans "Создать вакансию" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
        <form method="post" enctype="multipart/form-data" id="job-post-form">
            {% csrf_token %}
            
            <!-- Основные поля -->
            <div class="mb-3">
                <label for="{{ form.title.id_for_label }}" class="form-label">{{ form.title.label }}</label>
                {{ form.title|add_class:"form-control" }}
                {% if form.title.errors %}
                    <div class="text-danger">{{ form.title.errors.0 }}</div>
                {% endif %}
            </div>

            <div class="mb-3">
                <label for="{{ form.description.id_for_label }}" class="form-label">{{ form.description.label }}</label>
                {{ form.description|add_class:"form-control"|attr:"rows:3" }}
                {% if form.description.errors %}
                    <div class="text-danger">{{ form.description.errors.0 }}</div>
                {% endif %}
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="{{ form.price.id_for_label }}" class="form-label">{{ form.price.label }}</label>
                    {{ form.price|add_class:"form-control" }}
                    {% if form.price.errors %}
                        <div class="text-danger">{{ form.price.errors.0 }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    <label for="{{ form.currency.id_for_label }}" class="form-label">{{ form.currency.label }}</label>
                    {{ form.currency|add_class:"form-select" }}
                    {% if form.currency.errors %}
                        <div class="text-danger">{{ form.currency.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="{{ form.city.id_for_label }}" class="form-label">{{ form.city.label }}</label>
                    {{ form.city|add_class:"form-select" }}
                    {% if form.city.errors %}
                        <div class="text-danger">{{ form.city.errors.0 }}</div>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    <label for="{{ form.sub_rubric.id_for_label }}" class="form-label">{{ form.sub_rubric.label }}</label>
                    {{ form.sub_rubric|add_class:"form-select" }}
                    {% if form.sub_rubric.errors %}
                        <div class="text-danger">{{ form.sub_rubric.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            <!-- Поля специфичные для вакансий -->
            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="{{ form.experience.id_for_label }}" class="form-label">{{ form.experience.label }}</label>
                    {{ form.experience|add_class:"form-select" }}
                    {% if form.experience.errors %}
                        <div class="text-danger">{{ form.experience.errors.0 }}</div>
                    {% endif %}
                </div>
                <div class="col-md-4">
                    <label for="{{ form.work_schedule.id_for_label }}" class="form-label">{{ form.work_schedule.label }}</label>
                    {{ form.work_schedule|add_class:"form-select" }}
                    {% if form.work_schedule.errors %}
                        <div class="text-danger">{{ form.work_schedule.errors.0 }}</div>
                    {% endif %}
                </div>
                <div class="col-md-4">
                    <label for="{{ form.work_format.id_for_label }}" class="form-label">{{ form.work_format.label }}</label>
                    {{ form.work_format|add_class:"form-select" }}
                    {% if form.work_format.errors %}
                        <div class="text-danger">{{ form.work_format.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="mb-3">
                <label for="{{ form.user_phone.id_for_label }}" class="form-label">{{ form.user_phone.label }}</label>
                {{ form.user_phone|add_class:"form-control" }}
                {% if form.user_phone.errors %}
                    <div class="text-danger">{{ form.user_phone.errors.0 }}</div>
                {% endif %}
            </div>

        <!-- Телефон для связи -->
        <div class="mb-3">
            <label for="{{ form.user_phone.id_for_label }}" class="form-label">{% trans "Телефон для связи" %}</label>
            {% render_field form.user_phone class="form-control" error_class=WIDGET_ERROR_CLASS placeholder="+7 (XXX) XXX-XX-XX" %}
            <div class="invalid-feedback">{{ form.user_phone.errors|first }}</div>
            <div class="form-text">{% trans "Укажите номер телефона для связи с вами" %}</div>
        </div>

        <!-- Аддоны продвижения -->
        {% if not object %}
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">{% trans "Дополнительные опции продвижения" %}</h6>
            </div>
            <div class="card-body">
                <div class="mb-3 form-check">
                    {% render_field form.addon_photo class="form-check-input pricing-addon" data-toggle="image-field" %}
                    <label class="form-check-label" for="{{ form.addon_photo.id_for_label }}">
                        {{ form.addon_photo.label }} 
                        <small class="text-muted">({{ form.addon_photo.help_text }})</small>
                    </label>
                </div>
                
                <div class="mb-3 form-check">
                    {% render_field form.addon_highlight class="form-check-input pricing-addon" %}
                    <label class="form-check-label" for="{{ form.addon_highlight.id_for_label }}">
                        {{ form.addon_highlight.label }}
                        <small class="text-muted">({{ form.addon_highlight.help_text }})</small>
                    </label>
                </div>
                
                <div class="mb-3 form-check">
                    {% render_field form.addon_auto_bump class="form-check-input pricing-addon" %}
                    <label class="form-check-label" for="{{ form.addon_auto_bump.id_for_label }}">
                        {{ form.addon_auto_bump.label }}
                        <small class="text-muted">({{ form.addon_auto_bump.help_text }})</small>
                    </label>
                </div>
            </div>
        </div>

        <!-- Поле для изображения (показывается только при выборе аддона фото) -->
        <div id="image-field" class="mb-3" style="display: {{ form.addon_photo.value|yesno:'block,none' }};">
            <label for="{{ form.image.id_for_label }}" class="form-label">{% trans "Изображение" %}</label>
            {% render_field form.image class="form-control" error_class=WIDGET_ERROR_CLASS %}
            <div class="invalid-feedback">{{ form.image.errors|first }}</div>
            <div class="form-text">{% trans "Добавьте изображение к объявлению" %}</div>
        </div>

        <!-- Блок с расчетом стоимости -->
        <div id="pricing-summary" class="card mt-3">
            <div class="card-body">
                <h6>{% trans "Стоимость публикации" %}</h6>
                <div id="pricing-breakdown">
                    <!-- Сюда будет загружаться разбивка цен через HTMX -->
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Кнопки управления -->
        <div class="d-grid gap-3 d-md-flex justify-content-md-end">
            <button type='button' class='btn btn-secondary' data-bs-dismiss='modal'>{% trans "Отмена" %}</button>
            <button type="submit" id="submit-btn" class="btn btn-primary">
                {% if object %}
                    {% trans "Сохранить изменения" %}
                {% else %}
                    {% trans "Опубликовать" %}
                {% endif %}
            </button>
        </div> 
    </div>
</form>

<!-- ОТЛАДОЧНЫЙ СКРИПТ - временно -->
{% if not object %}
<script>
console.log('=== ОТЛАДКА НАЧАЛО ===');

// Запускаем сразу, так как скрипт уже в DOM
(function() {
    console.log('Отладочный скрипт запущен сразу');
    
    // Проверяем наличие элементов
    const form = document.querySelector('form[hx-post]');
    const submitBtn = document.querySelector('#submit-btn');
    const imageField = document.querySelector('#image-field');
    const pricingBreakdown = document.querySelector('#pricing-breakdown');
    const checkboxes = document.querySelectorAll('input[type=checkbox].pricing-addon');
    
    console.log('Элементы найдены:');
    console.log('  form:', form);
    console.log('  submitBtn:', submitBtn);
    console.log('  imageField:', imageField);
    console.log('  pricingBreakdown:', pricingBreakdown);
    console.log('  checkboxes:', checkboxes.length);
    
    // Добавляем обработчики напрямую
    checkboxes.forEach((cb, i) => {
        console.log(`Чекбокс ${i}:`, cb.name, cb.checked);
        cb.addEventListener('change', function() {
            console.log(`Чекбокс ${cb.name} изменен на:`, cb.checked);
            
            // Показать/скрыть поле изображения
            if (cb.name === 'addon_photo') {
                if (cb.checked) {
                    console.log('Показываем поле изображения');
                    imageField.style.display = 'block';
                } else {
                    console.log('Скрываем поле изображения');
                    imageField.style.display = 'none';
                }
            }
            
            // Обновить цену
            updatePrice();
        });
    });
    
    function updatePrice() {
        console.log('Обновляем цену...');
        const photoChecked = document.querySelector('input[name="addon_photo"]').checked;
        const highlightChecked = document.querySelector('input[name="addon_highlight"]').checked; 
        const autoBumpChecked = document.querySelector('input[name="addon_auto_bump"]').checked;
        
        console.log('Состояние аддонов:', {photoChecked, highlightChecked, autoBumpChecked});
        
        // Простая заглушка для проверки
        if (photoChecked || highlightChecked || autoBumpChecked) {
            pricingBreakdown.innerHTML = '<div class="text-info">Тестовая цена: 100 руб</div>';
            submitBtn.textContent = 'Оплатить 100 руб';
            submitBtn.className = 'btn btn-success';
        } else {
            pricingBreakdown.innerHTML = '<div class="text-success">Бесплатная публикация</div>';
            submitBtn.textContent = 'Опубликовать бесплатно';
            submitBtn.className = 'btn btn-primary';
        }
    }
    
    // Первоначальный вызов
    updatePrice();
})(); // Вызываем IIFE сразу

console.log('=== ОТЛАДКА КОНЕЦ ===');
</script>
{% endif %}

<script>
// Простое переключение поля изображения
document.addEventListener('change', function(e) {
    if (e.target.dataset.toggle === 'image-field') {
        document.getElementById('image-field').style.display = e.target.checked ? 'block' : 'none';
    }
});
</script>

{% endwith %}
